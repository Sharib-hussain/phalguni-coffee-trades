<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phalguni Coffee Trades â€” Today's Buying Price & History</title>
  <meta name="description" content="Daily buying prices (per kg) for Arabica & Robusta with 7-day history. Updated by Phalguni Coffee Trades." />
  <!-- Favicons -->
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/favicon.svg">
  <style>
    :root{
      --bg:#f7f2ec;
      --card:#fff;
      --accent:#6b4226;
      --accent-2:#a46b39;
      --muted:#7b6b61;
      --green:#557a46;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg) 0%, #fff 100%);color:var(--accent-2)}
    .wrap{max-width:980px;margin:28px auto;padding:22px}
    header{
      background: linear-gradient(to bottom, rgba(107,66,38,0.05), transparent);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .header-top{
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 20px;
    }
    .logo{
      width: 72px;
      height: 72px;
      border-radius: 16px;
      background: linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 20px;
      box-shadow: 0 8px 24px rgba(107,66,38,0.15);
      transition: transform 0.2s ease;
    }
    .logo:hover {
      transform: translateY(-2px);
    }
    h1{
      margin: 0;
      font-size: 28px;
      text-align: center;
      background: linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }
    p.lead{
      margin: 8px 0 0;
      color: var(--muted);
      text-align: center;
      font-size: 15px;
      letter-spacing: 0.2px;
    }
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(98,68,44,.06);min-height:120px;display:flex;flex-direction:column;justify-content:space-between}
    .type{font-size:13px;color:var(--muted);letter-spacing:0.6px}
    .price{font-weight:800;font-size:34px;color:var(--accent)}
    .meta{font-size:13px;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:10px;background:var(--accent);color:white;text-decoration:none;font-weight:600;cursor:pointer;border:none}
    .btn:disabled{opacity:.6;cursor:default}
    .btn.btn-secondary{background:var(--accent-2)}
    .btn .icon{font-size:16px}
    /* Copy success animation */
    @keyframes copySuccess {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .copy-success .icon{
      animation: copySuccess 0.5s ease-in-out;
    }
  /* loading state */
  .btn.loading{position:relative;padding-left:42px}
  .btn.loading::before{content:'';position:absolute;left:12px;top:50%;width:18px;height:18px;margin-top:-9px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:white;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
    .controls{display:flex;gap:12px;align-items:center}
    footer{margin-top:26px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(85,122,70,0.05),transparent);color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px}
    /* Contact card styles */
    .contact-card{
      max-width:500px;
      margin:0 auto;
      padding:24px !important;
    }
    .contact-header{
      margin:0;
      color:var(--accent);
      font-size:22px;
      text-align:center;
    }
    .contact-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin:16px 0;
    }
    .contact-item{
      text-align:center;
    }
    .contact-name{
      font-weight:700;
      color:var(--accent-2);
      margin-bottom:4px;
    }
    .contact-phone{
      color:var(--accent);
      font-weight:600;
    }
    .location{
      text-align:center;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(107,66,38,.1);
    }
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      .wrap{padding:14px}
      .logo{width:64px;height:64px}
      /* Mobile header layout */
      header{align-items:center;gap:12px;flex-wrap:wrap}
      header > div:nth-child(2){
        flex:1;
        min-width:200px;
        text-align:center;
      }
      .price{font-size:38px}
      .card{padding:16px}
      footer{flex-direction:column;gap:8px;align-items:flex-start}
      /* Floating action buttons */
      .fab{
        display:flex;
        position:fixed;
        right:18px;
        width:56px;
        height:56px;
        border-radius:50%;
        color:#fff;
        align-items:center;
        justify-content:center;
        border:none;
        cursor:pointer;
        z-index:40;
        transition:transform 0.2s;
      }
      .fab:hover{
        transform:scale(1.05);
      }
      .fab-primary{
        bottom:18px;
        background:var(--accent);
        box-shadow:0 8px 20px rgba(107,66,38,.18);
      }
      .fab-secondary{
        bottom:90px;
        background:var(--accent-2);
        box-shadow:0 8px 20px rgba(164,107,57,.18);
      }
      .fab.loading{
        padding:0;
      }
      .fab.copy-success{
        background:var(--green);
      }
    }
    body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(circle at 10% 20%, rgba(107,66,38,.02) 0 2px, transparent 2px), radial-gradient(circle at 80% 60%, rgba(107,66,38,.02) 0 3px, transparent 3px);pointer-events:none}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    table th, table td{border:1px solid #ddd;padding:8px;text-align:center}
    table th{background-color:var(--accent-2);color:white}
    canvas{margin-top:20px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-top">
        <div class="logo">PC</div>
        <div>
          <a id="refreshBtn" class="btn" href="#">Refresh</a>
        </div>
      </div>
      <div>
        <h1>Phalguni Coffee Trades</h1>
        <p class="lead">Live buying prices (per kg) & 7-day history</p>
      </div>
    </header>

    <main>
      <div class="grid">
        <div class="card" id="arabicaCard">
          <div>
            <div class="type">Arabica â€” Raw / Green (per kg)</div>
            <div class="price" id="arabicaPrice">â€”</div>
          </div>
          <div class="meta">Last updated: <span id="arabicaTime">â€”</span></div>
        </div>

        <div class="card" id="robustaCard">
          <div>
            <div class="type">Robusta â€” Raw / Green (per kg)</div>
            <div class="price" id="robustaPrice">â€”</div>
          </div>
          <div class="meta">Last updated: <span id="robustaTime">â€”</span></div>
        </div>
      </div>

      <h2>Price History (Past 7 Days)</h2>
      <table id="historyTable">
        <thead>
          <tr><th>Date</th><th>Arabica (â‚¹/kg)</th><th>Robusta (â‚¹/kg)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <canvas id="historyChart" height="150"></canvas>

      <div style="margin-top:18px">
        <div class="card contact-card">
          <h2 class="contact-header">Please Contact</h2>
          <div class="contact-grid">
            <div class="contact-item">
              <div class="contact-name">Samanth B P</div>
              <div class="contact-phone">+91 8277446831</div>
            </div>
            <div class="contact-item">
              <div class="contact-name">Mohammed Sharib</div>
              <div class="contact-phone">+91 7022824289</div>
            </div>
          </div>
          <div class="meta location">Location: Chickmagaluru Â· Accepting raw coffee from Planters</div>
        </div>
      </div>
    </main>

    <footer>
      <div class="small">Prices are per kg. For bulk orders please call.</div>
      <div class="small">Made with care Â· Phalguni Coffee Trades</div>
    </footer>
  </div>

  <!-- Floating action buttons -->
  <button id="fabRefresh" class="fab fab-primary" title="Refresh" style="display:none">âŸ³</button>
  <button id="copyMsg" class="fab fab-secondary" title="Copy Price Message">ðŸ“‹</button>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9DnNnxDj2n3Fy9-JVnnouxDoZ_VZ9au3wRXNO_s0CYLED7mGHPfpolUAhNCpNyeAvMJYD7kGXBl_K/pub?gid=0&single=true&output=csv";
    const priceMap = { Arabica: {priceEl: 'arabicaPrice', timeEl: 'arabicaTime'}, Robusta: {priceEl: 'robustaPrice', timeEl: 'robustaTime'} };

    async function fetchPrices(){
      try{
        if(!SHEET_CSV_URL || SHEET_CSV_URL.includes('REPLACE_WITH')){
          showPlaceholder();
          return;
        }
        const resp = await fetch(SHEET_CSV_URL, {cache: 'no-store'});
        if(!resp.ok) throw new Error('Failed to fetch sheet');
        const csv = await resp.text();
        const rows = csv.trim().split('\n').map(r=>r.split(','));
        const header = rows[0].map(h=>h.trim().toLowerCase());
        console.log('CSV Headers:', header); // Debug log
        const dataRows = rows.slice(-7); // last 7 rows for history
        console.log('Data rows:', dataRows); // Debug log

        // Convert rows to objects and sort by date to find most recent
        const sortedData = dataRows.map(row => ({
          date: row[0],
          arabica: row[1],
          robusta: row[2].replace('\r', ''),
          timestamp: new Date(row[0]).getTime()
        }))
        .sort((a, b) => b.timestamp - a.timestamp); // Sort newest to oldest

        // Get the latest prices (most recent date)
        const latest = sortedData[0];
        
        // Update current prices
        updateUI('Arabica', latest.arabica, latest.date);
        updateUI('Robusta', latest.robusta, latest.date);
        
        // Update history - use the already sorted data
        updateHistory(sortedData);
      }catch(err){
        console.error('Error fetching data:', err);
        document.getElementById('arabicaPrice').textContent = 'â€”';
        document.getElementById('robustaPrice').textContent = 'â€”';
        throw err; // rethrow so callers (refresh button) can react
      }
    }

    function updateUI(type, price, updatedAt){
      const mapping = priceMap[type];
      if(!mapping) return;
      document.getElementById(mapping.priceEl).textContent = 'â‚¹ ' + Number(price).toLocaleString('en-IN');
      document.getElementById(mapping.timeEl).textContent = updatedAt;
    }

    function updateHistory(data){
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = '';
      const labels = [], arabicaArr = [], robustaArr = [];
      data.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.date}</td><td>â‚¹ ${d.arabica}</td><td>â‚¹ ${d.robusta}</td>`;
        tbody.appendChild(tr);
        labels.push(d.date);
        arabicaArr.push(Number(d.arabica));
        robustaArr.push(Number(d.robusta));
      });
      // chart
      const ctx = document.getElementById('historyChart').getContext('2d');
      if(window.priceChart) window.priceChart.destroy();
      window.priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {label:'Arabica', data: arabicaArr, borderColor:'#6b4226', backgroundColor:'rgba(107,66,38,0.2)', tension:0.3},
            {label:'Robusta', data: robustaArr, borderColor:'#557a46', backgroundColor:'rgba(85,122,70,0.2)', tension:0.3}
          ]
        },
        options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:false}}}
      });
    }

    function showPlaceholder(){
      document.getElementById('arabicaPrice').textContent = 'â€”';
      document.getElementById('robustaPrice').textContent = 'â€”';
    }

    // Button helpers
    const refreshBtn = document.getElementById('refreshBtn');
    const fabRefresh = document.getElementById('fabRefresh');

    function setButtonLoading(el, isLoading){
      if(!el) return;
      if(isLoading){
        el.classList.add('loading');
        el.disabled = true;
        el.dataset.orig = el.textContent;
        el.textContent = 'Loadingâ€¦';
      } else {
        el.classList.remove('loading');
        el.disabled = false;
        if(el.dataset.orig) el.textContent = el.dataset.orig;
      }
    }

    function setButtonText(el, text){ if(el) el.textContent = text; }

    // Wrapper that shows loading state and calls fetchPrices
    async function handleRefreshClick(e){
      e && e.preventDefault();
      // Shift/Ctrl click => hard reload
      if(e && (e.shiftKey || e.ctrlKey)){
        window.location.reload();
        return;
      }
      setButtonLoading(refreshBtn, true);
      setButtonLoading(fabRefresh, true);
      try{
        await fetchPrices();
        setButtonText(refreshBtn, 'Updated');
        setButtonText(fabRefresh, 'âœ“');
        await new Promise(r=>setTimeout(r,1200));
      }catch(err){
        setButtonText(refreshBtn, 'Error');
        setButtonText(fabRefresh, 'âš ');
        console.error('Refresh failed:', err);
        await new Promise(r=>setTimeout(r,1500));
      } finally{
        setButtonLoading(refreshBtn, false);
        setButtonLoading(fabRefresh, false);
        setButtonText(refreshBtn, 'Refresh');
        setButtonText(fabRefresh, 'âŸ³');
      }
    }

    refreshBtn.addEventListener('click', handleRefreshClick);
    fabRefresh.addEventListener('click', handleRefreshClick);

    // Show/hide fab on small screens
    function updateFabVisibility(){
      if(window.matchMedia && window.matchMedia('(max-width:720px)').matches){
        fabRefresh.style.display = 'flex';
      } else {
        fabRefresh.style.display = 'none';
      }
    }
    window.addEventListener('resize', updateFabVisibility);
    updateFabVisibility();

    // Make fetchPrices rethrow so wrapper can react to errors
    const originalFetchPrices = fetchPrices;
    async function fetchPricesWrapper(){
      try{
        await originalFetchPrices();
      }catch(err){
        throw err;
      }
    }

    // Message copy functionality
    const copyBtn = document.getElementById('copyMsg');
    
    function generatePriceMessage() {
      const arabicaPrice = document.getElementById('arabicaPrice').textContent.trim();
      const robustaPrice = document.getElementById('robustaPrice').textContent.trim();
      const date = document.getElementById('arabicaTime').textContent.trim();
      
      return `Phalguni Coffee Trades

Date: ${date}
Arabica Raw Coffee: ${arabicaPrice}
Robusta Raw Coffee: ${robustaPrice}

Contact Details:
Samanth B P: +91 8277446831
Mohammed Sharib: +91 7022824289

Location: Chickmagaluru
Accepting raw coffee from Planters`;
    }

    copyBtn.addEventListener('click', async function() {
      try {
        const message = generatePriceMessage();
        await navigator.clipboard.writeText(message);
        
        // Visual feedback
        copyBtn.classList.add('copy-success');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<span class="icon">âœ“</span> Copied!';
        
        setTimeout(() => {
          copyBtn.classList.remove('copy-success');
          copyBtn.innerHTML = originalText;
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
        alert('Could not copy message. Please try again.');
      }
    });

    // Call the fetch on load but silence errors (UI already shows them)
    fetchPrices().catch(()=>{});
  </script>
</body>
</html>
